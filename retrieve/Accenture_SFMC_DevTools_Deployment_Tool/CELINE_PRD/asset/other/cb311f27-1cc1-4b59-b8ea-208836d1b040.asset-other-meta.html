%%[
/* Retrieving the Subscriber Key and Status, the Email Address and the Language */
VAR @skey

IF EMPTY(_subscriberkey) THEN
    SET @skey = ContactKey
ELSE
    SET @skey = _subscriberkey
ENDIF

/* @found this variables is set tot true when a correspounding line is found in EMAIL_BODY_TRANSLATION DE is found */
VAR @found

/* Retrieving the Language, the Region Main Store, the Address 1 Country, the Nationality, the Country Main Store and the Address 1 City of the Subscriber from the Main Data Extension Contacts */
VAR @language, @regionMainStore, @country, @nationality, @countryMainStore, @city

VAR @rows 
SET @rows = LookupRows("Contacts", "ContactKey", @skey)
IF Rowcount(@rows) > 0 THEN
    VAR @row
    SET @row = Row(@rows, 1)
    SET @language = Field(@row, "Language")
    SET @regionMainStore = Field(@row, "Region Main Store")
    SET @country = Field(@row, "Address 1 Country")
    SET @nationality = Field(@row, "Nationality")
    SET @countryMainStore = Field(@row, "Country Main Store")
    SET @city = Field(@row, "Address 1 City")
   /* For Proofing we need to get the variables from the Proof Data Extension not from the Contacts DE, because we do not have the same subscribers keys*/ 
ELSE
      SET @rows = LookupRows(_DataSourceName , "ContactKey", @skey)
      IF Rowcount(@rows) > 0 THEN
        VAR @row
        SET @row = Row(@rows, 1)
        SET @language = Field(@row, "Language")
        SET @regionMainStore = Field(@row, "Region Main Store")
        SET @country = Field(@row, "Address 1 Country")
        SET @nationality = Field(@row, "Nationality")
        SET @countryMainStore = Field(@row, "Country Main Store")
        SET @city = Field(@row, "Address 1 City")
    ENDIF   
    
ENDIF

/* Searching Text Blocks From Translation Data Extension EMAIL_BODY_TRANSLATION */

VAR @visualImage, @visualImageLink, @visualCTALineText_1, @visualCTALineText_2, @visualCTALink

/* Setting available Languages to avoid Errors */ 
/* VAR @availableRegionMainStores */
/* SET @availableRegionMainStores = "EUR MDE US APAC JAPAN CHINA" */
/* IndexOf(@availableRegionMainStores,@regionMainStore) > 0 */ 

IF (@language=="FR" OR @language=="ES" OR @language=="CHT" OR @language=="CHS" OR @language=="JP") THEN
    VAR @rows
    SET @rows = LookupRows("EMAIL_BODY_TRANSLATION", "Language", @language)

    IF Rowcount(@rows) > 0 THEN
        SET @found = "true"

        VAR @rowSelected
        SET @rowSelected = Row(@rows, 1)

        SET @visualImage = Field(@rowSelected, "Visual Image")
        SET @visualImageLink = Field(@rowSelected, "Visual Image Link")
        SET @visualCTALineText_1 = Field(@rowSelected, "Visual CTA Line 1 Text")
        SET @visualCTALineText_2 = Field(@rowSelected, "Visual CTA Line 2 Text")
        SET @visualCTALink = Field(@rowSelected, "Visual CTA Link")
    ENDIF

ELSEIF (@city=="HAWAIIAN GARDENS" OR @city=="HONO HAWAII" OR @city=="HAWAII" OR @city=="HAWAI HONOLULU" OR @countryMainStore=="US006") THEN
        
    VAR @rows
    /* Country Main Store = "HAWAII" to be checked later */
    SET @rows = LookupRows("EMAIL_BODY_TRANSLATION", "City", "HAWAI")

    IF Rowcount(@rows) > 0 THEN

        SET @found = "true"

        VAR @rowSelected
        SET @rowSelected = Row(@rows, 1)

        SET @visualImage = Field(@rowSelected, "Visual Image")
        SET @visualImageLink = Field(@rowSelected, "Visual Image Link")
        SET @visualCTALineText_1 = Field(@rowSelected, "Visual CTA Line 1 Text")
        SET @visualCTALineText_2 = Field(@rowSelected, "Visual CTA Line 2 Text")
        SET @visualCTALink = Field(@rowSelected, "Visual CTA Link")
    ENDIF

ELSEIF (@language=="EN" AND NOT EMPTY(@regionMainStore) AND NOT EMPTY(@country)) THEN
    VAR @rows
    SET @rows = LookupRows("EMAIL_BODY_TRANSLATION", "Language", @language, "Region Main Store", @regionMainStore, "Country", @country)

    IF Rowcount(@rows) > 0 THEN

        SET @found = "true"
    
        VAR @rowSelected
        SET @rowSelected = Row(@rows, 1)
        
        /* Checking if the selected line concerns hawai, if it does go to the second line */
        VAR @hawaiCity
        SET @hawaiCity = Field(@rowSelected, "City")
        IF @hawaiCity=="HAWAI" THEN
            SET @rowSelected = Row(@rows, 2)
        ENDIF

        SET @visualImage = Field(@rowSelected, "Visual Image")
        SET @visualImageLink = Field(@rowSelected, "Visual Image Link")
        SET @visualCTALineText_1 = Field(@rowSelected, "Visual CTA Line 1 Text")
        SET @visualCTALineText_2 = Field(@rowSelected, "Visual CTA Line 2 Text")
        SET @visualCTALink = Field(@rowSelected, "Visual CTA Link")
    ENDIF

ELSE
    VAR @rows
    SET @rows = LookupRows("EMAIL_BODY_TRANSLATION", "Language", "Default")

    IF Rowcount(@rows) > 0 THEN

        SET @found = "true"

        VAR @rowSelected
        SET @rowSelected = Row(@rows, 1)

        SET @visualImage = Field(@rowSelected, "Visual Image")
        SET @visualImageLink = Field(@rowSelected, "Visual Image Link")
        SET @visualCTALineText_1 = Field(@rowSelected, "Visual CTA Line 1 Text")
        SET @visualCTALineText_2 = Field(@rowSelected, "Visual CTA Line 2 Text")
        SET @visualCTALink = Field(@rowSelected, "Visual CTA Link")
    ENDIF

ENDIF

IF @found != "true" THEN 

    VAR @rows
    SET @rows = LookupRows("EMAIL_BODY_TRANSLATION", "Language", "Default")

    IF Rowcount(@rows) > 0 THEN
    
        VAR @rowSelected
        SET @rowSelected = Row(@rows, 1)

        SET @visualImage = Field(@rowSelected, "Visual Image")
        SET @visualImageLink = Field(@rowSelected, "Visual Image Link")
        SET @visualCTALineText_1 = Field(@rowSelected, "Visual CTA Line 1 Text")
        SET @visualCTALineText_2 = Field(@rowSelected, "Visual CTA Line 2 Text")
        SET @visualCTALink = Field(@rowSelected, "Visual CTA Link")
    ENDIF
ENDIF


]%%